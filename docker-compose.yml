version: '3.8'

services:
  # Frontend UI
  ui:
    build:
      context: .
      dockerfile: Dockerfile
      target: ui
      args:
        - VITE_SERVER_URL=${VITE_SERVER_URL}
        - VITE_HOSTNAME=autoserver.setrox.com.tr
    container_name: automaker-ui
    restart: unless-stopped
    ports:
      - '3007:80'
    depends_on:
      - server

  # Backend API Server
  server:
    build:
      context: .
      dockerfile: Dockerfile
      target: server
      args:
        - UID=1000
        - GID=1000
    container_name: automaker-server
    restart: unless-stopped
    ports:
      - '3008:3008'
    environment:
      - VITE_SERVER_URL=${VITE_SERVER_URL}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # EKLENDİ: GitHub Token'ı içeri aktarıyoruz
      - GH_TOKEN=${GH_TOKEN}
      - GITHUB_TOKEN=${GH_TOKEN}
      
      # Diğer ayarlar
      - CLAUDE_OAUTH_CREDENTIALS=${CLAUDE_OAUTH_CREDENTIALS:-}
      - CURSOR_AUTH_TOKEN=${CURSOR_AUTH_TOKEN:-}
      - AUTOMAKER_API_KEY=${AUTOMAKER_API_KEY:-}
      - ALLOWED_ROOT_DIRECTORY=/projects
      - DATA_DIR=/data
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3007}
      - IS_CONTAINERIZED=true
      - HOME=/home/automaker
    volumes:
      - automaker-data:/data
      - automaker-projects:/projects
      
      # Login bilgilerini tutan klasörler (Eksikler tamamlandı)
      - automaker-claude-config:/home/automaker/.claude
      - automaker-cursor-config:/home/automaker/.cursor
      
      # GitHub CLI Config (GitHub login bilgilerini tutar)
      - automaker-gh-config:/home/automaker/.config/gh
      
      # OpenCode verileri
      - automaker-opencode-data:/home/automaker/.local/share/opencode
      - automaker-opencode-config:/home/automaker/.config/opencode
      - automaker-opencode-cache:/home/automaker/.cache/opencode

volumes:
  automaker-data:
    name: automaker-data
  automaker-projects:
    name: automaker-projects
  automaker-claude-config:
    name: automaker-claude-config
  automaker-cursor-config:
    name: automaker-cursor-config
  automaker-gh-config:  # Yeni volume
    name: automaker-gh-config
  automaker-opencode-data:
    name: automaker-opencode-data
  automaker-opencode-config:
    name: automaker-opencode-config
  automaker-opencode-cache:
    name: automaker-opencode-cache
