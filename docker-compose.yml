version: '3.8'

services:
  # Frontend UI
  ui:
    build:
      context: .
      dockerfile: Dockerfile
      target: ui
      # BURASI ÖNEMLİ: UI build edilirken backend adresini içine alacak
      args:
        - VITE_SERVER_URL=${VITE_SERVER_URL}
    container_name: automaker-ui
    restart: unless-stopped
    ports:
      - '3007:80'
    depends_on:
      - server

  # Backend API Server
  server:
    build:
      context: .
      dockerfile: Dockerfile
      target: server
      args:
        # Bu değerler Dockerfile içindeki kullanıcı ID'si ile eşleşmeli
        - UID=1000
        - GID=1000
    container_name: automaker-server
    restart: unless-stopped
    ports:
      - '3008:3008'
    environment:
      # Build sırasında verilen değişkeni runtime'da da veriyoruz
      - VITE_SERVER_URL=${VITE_SERVER_URL} 
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_OAUTH_CREDENTIALS=${CLAUDE_OAUTH_CREDENTIALS:-}
      - CURSOR_AUTH_TOKEN=${CURSOR_AUTH_TOKEN:-}
      - AUTOMAKER_API_KEY=${AUTOMAKER_API_KEY:-}
      - ALLOWED_ROOT_DIRECTORY=/projects
      - DATA_DIR=/data
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3007}
      - IS_CONTAINERIZED=true
      # Home dizini doğru tanımlanmalı ki CLI araçları oraya baksın
      - HOME=/home/automaker
    volumes:
      # GENEL VERİLER (Projeler, ayarlar vs.)
      - automaker-data:/data
      - automaker-projects:/projects
      
      # LOGIN BİLGİLERİNİ TUTAN KRİTİK KLASÖRLER
      # Claude giriş bilgileri
      - automaker-claude-config:/home/automaker/.claude
      
      # Cursor giriş bilgileri
      - automaker-cursor-config:/home/automaker/.cursor
      
      # OpenCode giriş ve cache bilgileri
      - automaker-opencode-data:/home/automaker/.local/share/opencode
      - automaker-opencode-config:/home/automaker/.config/opencode
      - automaker-opencode-cache:/home/automaker/.cache/opencode

# Volume Tanımları (Verilerin saklandığı depolar)
volumes:
  automaker-data:
    name: automaker-data
  automaker-projects:
    name: automaker-projects
  automaker-claude-config:
    name: automaker-claude-config
  automaker-cursor-config:
    name: automaker-cursor-config
  automaker-opencode-data:
    name: automaker-opencode-data
  automaker-opencode-config:
    name: automaker-opencode-config
  automaker-opencode-cache:
    name: automaker-opencode-cache
